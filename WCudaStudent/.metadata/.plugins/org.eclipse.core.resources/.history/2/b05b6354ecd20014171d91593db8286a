#include <iostream>

#include "Indice2D.h"
#include "cudaTools.h"
#include "Device.h"
#include "IndiceTools.h"
#include "DomaineMath.h"

#include "RayTracingMath.h"
#include "ConstantMemoryLink.h"

using std::cout;
using std::endl;

#define LENGTH 50
__constant__ Sphere TAB_DATA_CM[LENGTH];

__host__ Sphere* instanciateSpheres(Sphere*,int);
__host__ void destructSpheres(Sphere*);

__global__ void rayTracing(uchar4* ptrDevPixels, int w, int h, Sphere* ptrDevSpheres, DomaineMath domaineMath, const int NB_SPHERE, float t)
    {
    RayTracingMath rayTracingMath(ptrDevSpheres,LENGTH);

    int tid = Indice2D::tid();
    int nbThread = Indice2D::nbThread();
    const int MAX = w*h;

    int i,j;
    double x,y;
    int s = tid;
    while(s < MAX)
	{
	IndiceTools::toIJ(s,w,&i,&j);
	domaineMath.toXY(i,j,&x,&y);

	rayTracingMath.colorXY(x, y, t, &ptrDevPixels[s]);
	s += nbThread;
	}
    }

__host__ ConstantMemoryLink constantMemoryLink(void)
    {
    Sphere* ptrDevTabData;
    size_t sizeAll = LENGTH * sizeof(Sphere);
    HANDLE_ERROR(cudaGetSymbolAddress((void **) &ptrDevTabData, TAB_DATA_CM));
    ConstantMemoryLink cmLink =
           {
        	   (void**) ptrDevTabData, LENGTH, sizeAll
           };
    return cmLink;
}

__host__ Sphere* instanciateSpheres(Sphere* ptrSpheres, int n)
    {
    //Sphere* ptrDevSpheres;

    ConstantMemoryLink cmLink = constantMemoryLink();
    Sphere* ptrDevSpheres = (Sphere*)cmLink.ptrDevTab;
    size_t sizeALL = cmLink.sizeAll;

    //HANDLE_ERROR(cudaMalloc((void**)&ptrDevSpheres, sizeof(Sphere)*n));
    HANDLE_ERROR(cudaMemcpy(ptrDevSpheres, ptrSpheres, sizeALL, cudaMemcpyHostToDevice));

    return ptrDevSpheres;
    }

__host__ void destructSpheres(Sphere* ptrDevSpheres)
    {
    HANDLE_ERROR(cudaFree(ptrDevSpheres));
    }

/*----------------------------------------------------------------------*\
 |*			End	 					*|
 \*---------------------------------------------------------------------*/
